NIP-24
======

Private, Encrypted Direct Messages
----------------------------------

`draft` `optional` `author:jeffthibault`

This NIP defines a scheme for clients to send [NIP-04](https://github.com/nostr-protocol/nips/blob/master/04.md) direct messages more privately. The event format is exactly the same as in NIP-04.

Example
-------

Alice and Bob want to send private messages to each other.

**Definitions:**<br>
`A[sk]` = Alice's private key<br>
`A[pk]` = Alice's public key<br>
`A[dk]` = Alice's decoy key<br>
`B[sk]` = Bob's private key<br>
`B[pk]` = Bob's public key<br>
`B[dk]` = Bob's decoy key<br>
`AB[ss]` = Alice and Bob's shared secret, derived using `ECDH(A[sk], B[pk])` or `ECDH(B[sk], A[pk])`

**Step 1:**<br>
Note: If either Alice or Bob do not know the other's public key, then one of them MUST send a standard NIP-04 message to the other. If, and only if, Alice and Bob *both* know the other's public key, then Step 1 can be ignored.

Upon sending or receiving the first direct message, each client SHOULD add the other to their [NIP-02](https://github.com/nostr-protocol/nips/blob/master/02.md) contact list, but MUST at least save the other's public key locally if they want to continue messaging.

**Step 2:**<br>
Alice and Bob establish `Decoy Keys`, with which they will send and receive all subsequent messages to and from.

Alice's decoy key is defined as `A[dk] = SHA256(SHA256(AB[ss]) + A[pk])`<br>
Bob's decoy key is defined as `B[dk] = SHA256(SHA256(AB[ss]) + B[pk])`

Because the decoy keys are derived from the shared secret between Alice and Bob, they are known only by them.

**Step 3:**<br>
Bobs' messages to Alice MUST now have `p` tags in the form `["p", "<A[dk]>"]`<br>
Alices' messages to Bob MUST now have `p` tags in the form `["p", "<B[dk]>"]`

**Step 4:**<br>
Alice MUST now update her subscription for her NIP-04 messages to include her decoy key for this chat as follows:<br>
`["REQ", "my-dms", {"kinds": [4], "authors": ["<A[pk]>"], "#p": ["<A[pk]>", "<A[dk]>"]}`

Bob MUST now update his subscription for his NIP-04 messages to include his decoy key for this chat as follows:<br>
`["REQ", "my-dms", {"kinds": [4], "authors": ["<B[pk]>"], "#p": ["<B[pk]>", "<B[dk]>"]}`

Motivation
----------

NIP-04 is flawed because only event content is encrypted and not the metadata about it, and by the nature of Nostr as a protocol designed for public communication in general anyone is able to query relays for any event they want -- thus it's possible to anyone to track conversations between any other Nostr users, not exactly what they're saying, but to whom they're chatting and how often.

Privacy Analysis
----------------

If either Alice or Bob does not know the other's public key and has to send a standard NIP-04 message to start a chat, then that message is leaked to outside observers. However, it is *only* that first message which is leaked. Going forward, an outside observer would only be able to see that Alice and Bob are sending messages to seemingly random public keys. So it is not conclusive that they have maintained a conversation with each other.

An outside observer might be able to do some timing analysis if they can determine a pattern between when Alice messages Bob's decoy key and when Bob messages Alice's decoy key, but again, this is not conclusive as it is based on heuristics.

If this NIP is used in conjunction with the proposed [NIP-21](https://github.com/nostr-protocol/nips/pull/20), that adds some extra privacy by mitigating the risk that an outside observer sees the first message and therfore will never know that a direct chat was even attempted.

Acknowledgements
----------------

**vinliao** - for proposing a similar idea in https://github.com/nostr-protocol/nostr/issues/69<br>
**fiatjaf** - for the `Motivation` section, it is taken from https://github.com/nostr-protocol/nips/blob/nip-21-non-public-dms/21.md `Rationale` section. See that for more information. 

